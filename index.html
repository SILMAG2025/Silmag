<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="manifest" href="manifest.json" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventario EPP</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table, th, td { border: 1px solid black; border-collapse: collapse; padding: 8px; }
    table { width: 100%; margin-top: 20px; }
    input, button { margin: 5px; padding: 8px; }
    #searchInput { width: 100%; padding: 8px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Inventario EPP</h1>

  <input type="file" id="fileInput" accept=".xlsx" />

  <div>
    <input type="text" id="itemName" placeholder="EPP" />
    <input type="number" id="itemQuantity" placeholder="Cantidad" />
    <input type="text" id="itemCode" placeholder="Marca (opcional)" />
    <input type="text" id="itemLocation" placeholder="Talle (opcional)" />
    <br />
    <button onclick="agregar()">Agregar</button>
    <button onclick="sumar()">Sumar</button>
    <button onclick="restar()">Restar</button>
    <button onclick="editarCodigo()">Agregar/Editar Marca</button>
    <button onclick="editarUbicacion()">Agregar/Editar Talle</button>
    <button onclick="descargarExcel()">Descargar Excel</button>
  </div>

  <input type="text" id="searchInput" placeholder="Buscar por EPP o Marca..." oninput="buscarInventario()" />

  <table id="inventoryTable">
    <thead>
      <tr>
        <th>Cantidad</th>
        <th>EPP</th>
        <th>Marca</th>
        <th>Talle</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let inventario = {};

    document.getElementById('fileInput').addEventListener('change', function(e) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet);

        inventario = {};
        json.forEach(row => {
          const epp = normalizarNombre(row.EPP);
          inventario[epp] = {
            codigo: row.Marca || '—',
            cantidad: parseInt(row.Cantidad) || 0,
            ubicacion: row.Talle || ''
          };
        });

        mostrarInventario();
        guardarInventario();
      };
      reader.readAsArrayBuffer(e.target.files[0]);
    });

    function mostrarInventario(filtrado = null) {
      const tbody = document.querySelector('#inventoryTable tbody');
      tbody.innerHTML = '';

      const lista = filtrado || Object.entries(inventario);

      for (const [epp, datos] of lista) {
        const row = document.createElement('tr');

        const tdCantidad = document.createElement('td');
        tdCantidad.textContent = datos.cantidad;

        const tdEpp = document.createElement('td');
        tdEpp.textContent = epp;
        tdEpp.style.cursor = 'pointer';
        tdEpp.onclick = () => {
          document.getElementById('itemName').value = epp;
          document.getElementById('itemCode').value = datos.codigo || '';
          document.getElementById('itemLocation').value = datos.ubicacion || '';
        };

        const tdMarca = document.createElement('td');
        tdMarca.textContent = datos.codigo || '—';

        const tdTalle = document.createElement('td');
        tdTalle.textContent = datos.ubicacion || '';

        row.appendChild(tdCantidad);
        row.appendChild(tdEpp);
        row.appendChild(tdMarca);
        row.appendChild(tdTalle);
        tbody.appendChild(row);
      }
    }

    function buscarInventario() {
      const texto = document.getElementById('searchInput').value.trim().toLowerCase();
      if (texto === '') {
        mostrarInventario();
        return;
      }

      const filtrado = Object.entries(inventario).filter(([epp, datos]) => {
        return epp.includes(texto) || (datos.codigo && datos.codigo.toLowerCase().includes(texto));
      });

      mostrarInventario(filtrado);
    }

    function normalizarNombre(nombre) {
      return nombre.trim().toLowerCase();
    }

    function agregar() {
      const eppOriginal = document.getElementById('itemName').value;
      const cantidad = parseInt(document.getElementById('itemQuantity').value);
      const marca = document.getElementById('itemCode').value || '—';
      const talle = document.getElementById('itemLocation').value || '';

      if (!eppOriginal || isNaN(cantidad)) return;

      const epp = normalizarNombre(eppOriginal);
      inventario[epp] = {
        codigo: marca,
        cantidad: cantidad,
        ubicacion: talle
      };
      mostrarInventario();
      guardarInventario();
    }

    function sumar() {
      const eppOriginal = document.getElementById('itemName').value;
      const cantidad = parseInt(document.getElementById('itemQuantity').value);
      if (!eppOriginal || isNaN(cantidad)) return;

      const epp = normalizarNombre(eppOriginal);
      if (!inventario[epp]) {
        inventario[epp] = { codigo: '—', cantidad: 0, ubicacion: '' };
      }
      inventario[epp].cantidad += cantidad;
      mostrarInventario();
      guardarInventario();
    }

    function restar() {
      const eppOriginal = document.getElementById('itemName').value;
      const cantidad = parseInt(document.getElementById('itemQuantity').value);
      if (!eppOriginal || isNaN(cantidad)) return;

      const epp = normalizarNombre(eppOriginal);
      if (!inventario[epp]) {
        inventario[epp] = { codigo: '—', cantidad: 0, ubicacion: '' };
      }
      inventario[epp].cantidad -= cantidad;
      if (inventario[epp].cantidad < 0) inventario[epp].cantidad = 0;
      mostrarInventario();
      guardarInventario();
    }

    function editarCodigo() {
      const eppOriginal = document.getElementById('itemName').value;
      const nuevaMarca = document.getElementById('itemCode').value;
      if (!eppOriginal || !nuevaMarca) return;

      const epp = normalizarNombre(eppOriginal);
      if (!inventario[epp]) {
        alert('Ese EPP no existe en el inventario.');
        return;
      }

      inventario[epp].codigo = nuevaMarca;
      mostrarInventario();
      guardarInventario();
    }

    function editarUbicacion() {
      const eppOriginal = document.getElementById('itemName').value;
      const nuevoTalle = document.getElementById('itemLocation').value;
      if (!eppOriginal || !nuevoTalle) return;

      const epp = normalizarNombre(eppOriginal);
      if (!inventario[epp]) {
        alert('Ese EPP no existe en el inventario.');
        return;
      }

      inventario[epp].ubicacion = nuevoTalle;
      mostrarInventario();
      guardarInventario();
    }

    function descargarExcel() {
      const data = Object.entries(inventario).map(([epp, datos]) => ({
        Cantidad: datos.cantidad,
        EPP: epp,
        Marca: datos.codigo || '—',
        Talle: datos.ubicacion || ''
      }));
      if (data.length === 0) {
        alert('El inventario está vacío.');
        return;
      }
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
      XLSX.writeFile(wb, 'Inventario_EPP.xlsx');
    }

    function guardarInventario() {
      localStorage.setItem('inventario', JSON.stringify(inventario));
    }

    function cargarInventario() {
      const data = localStorage.getItem('inventario');
      if (data) {
        inventario = JSON.parse(data);
        mostrarInventario();
      }
    }
    cargarInventario();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('Service Worker registrado:', reg.scope))
          .catch(err => console.log('Error al registrar Service Worker:', err));
      });
    }
  </script>
</body>
</html>
