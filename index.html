<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="manifest" href="manifest.json" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventario EPP</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table, th, td { border: 1px solid black; border-collapse: collapse; padding: 8px; }
    table { width: 100%; margin-top: 20px; }
    input, button { margin: 5px; padding: 8px; }
    #searchInput { width: 100%; padding: 8px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Inventario EPP</h1>

  <input type="file" id="fileInput" accept=".xlsx" />

  <div>
    <input type="text" id="itemName" placeholder="EPP" />
    <input type="number" id="itemQuantity" placeholder="Cantidad" />
    <input type="text" id="itemCode" placeholder="Marca (opcional)" />
    <input type="text" id="itemLocation" placeholder="Talle (opcional)" />
    <br />
    <button onclick="agregar()">Agregar</button>
    <button onclick="sumar()">Sumar</button>
    <button onclick="restar()">Restar</button>
    <button onclick="editarCodigo()">Agregar/Editar Marca</button>
    <button onclick="editarUbicacion()">Agregar/Editar Talle</button>
    <button onclick="descargarExcel()">Descargar Excel</button>
  </div>

  <input type="text" id="searchInput" placeholder="Buscar por EPP o Marca..." oninput="buscarInventario()" />

  <table id="inventoryTable">
    <thead>
      <tr>
        <th>Cantidad</th>
        <th>EPP</th>
        <th>Marca</th>
        <th>Talle</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    /************************************
     * Helpers
     ***********************************/
    const getField = (row, aliases) => {
      for (const alias of aliases) {
        if (alias in row && row[alias] !== undefined && row[alias] !== null && row[alias] !== '') {
          return row[alias];
        }
      }
      return '';
    };

    const normalizarNombre = nombre => (nombre || '').toString().trim().toLowerCase();

    /************************************
     * Datos en memoria
     ***********************************/
    let inventario = {};

    /************************************
     * Importar Excel (soporta formatos viejos y nuevos, mayúsculas/acentos)
     ***********************************/
    document.getElementById('fileInput').addEventListener('change', function (e) {
      const reader = new FileReader();
      reader.onload = function (ev) {
        const data = new Uint8Array(ev.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });

        inventario = {};

        json.forEach(row => {
          const eppRaw      = getField(row, ['EPP','epp','Producto','producto','PRODUCTO']);
          if (!eppRaw) return; // fila vacía

          const cantidadRaw = getField(row, ['Cantidad','cantidad','CANTIDAD','Quantity','quantity']);
          const marcaRaw    = getField(row, ['Marca','marca','MARCA','Código','Codigo','código','codigo','CÓDIGO','CODIGO']);
          const talleRaw    = getField(row, ['Talle','talle','TALLE','Ubicación','ubicacion','UBICACIÓN','ubicación']);

          const epp = normalizarNombre(eppRaw);
          inventario[epp] = {
            cantidad: parseInt(cantidadRaw) || 0,
            codigo:   (marcaRaw || '—').toString(),
            ubicacion:(talleRaw || '').toString()
          };
        });

        mostrarInventario();
        guardarInventario();
      };
      reader.readAsArrayBuffer(e.target.files[0]);
    });

    /************************************
     * Renderizado y búsqueda
     ***********************************/
    function mostrarInventario(filtrado = null) {
      const tbody = document.querySelector('#inventoryTable tbody');
      tbody.innerHTML = '';

      const lista = filtrado || Object.entries(inventario);

      for (const [epp, datos] of lista) {
        const row = document.createElement('tr');

        row.innerHTML = `
          <td>${datos.cantidad}</td>
          <td style="cursor:pointer">${epp}</td>
          <td>${datos.codigo}</td>
          <td>${datos.ubicacion}</td>
        `;

        // Rellenar inputs al hacer clic
        row.children[1].onclick = () => {
          document.getElementById('itemName').value = epp;
          document.getElementById('itemCode').value = datos.codigo === '—' ? '' : datos.codigo;
          document.getElementById('itemLocation').value = datos.ubicacion;
        };

        tbody.appendChild(row);
      }
    }

    function buscarInventario() {
      const texto = document.getElementById('searchInput').value.trim().toLowerCase();
      if (texto === '') return mostrarInventario();

      const filtrado = Object.entries(inventario).filter(([epp, datos]) =>
        epp.includes(texto) || (datos.codigo && datos.codigo.toLowerCase().includes(texto))
      );
      mostrarInventario(filtrado);
    }

    /************************************
     * Operaciones CRUD
     ***********************************/
    function agregar() {
      const eppOriginal = document.getElementById('itemName').value;
      const cantidad    = parseInt(document.getElementById('itemQuantity').value);
      const marca       = document.getElementById('itemCode').value || '—';
      const talle       = document.getElementById('itemLocation').value || '';

      if (!eppOriginal || isNaN(cantidad)) return;

      const epp = normalizarNombre(eppOriginal);
      inventario[epp] = { cantidad, codigo: marca, ubicacion: talle };
      mostrarInventario();
      guardarInventario();
    }

    function sumar() {
      const eppOriginal = document.getElementById('itemName').value;
      const cantidad    = parseInt(document.getElementById('itemQuantity').value);
      if (!eppOriginal || isNaN(cantidad)) return;

      const epp = normalizarNombre(eppOriginal);
      if (!inventario[epp]) inventario[epp] = { cantidad: 0, codigo: '—', ubicacion: '' };
      inventario[epp].cantidad += cantidad;
      mostrarInventario();
      guardarInventario();
    }

    function restar() {
      const eppOriginal = document.getElementById('itemName').value;
      const cantidad    = parseInt(document.getElementById('itemQuantity').value);
      if (!eppOriginal || isNaN(cantidad)) return;

      const epp = normalizarNombre(eppOriginal);
      if (!inventario[epp]) inventario[epp] = { cantidad: 0, codigo: '—', ubicacion: '' };
      inventario[epp].cantidad = Math.max(inventario[epp].cantidad - cantidad, 0);
      mostrarInventario();
      guardarInventario();
    }

    function editarCodigo() {
      const eppOriginal = document.getElementById('itemName').value;
      const nuevaMarca  = document.getElementById('itemCode').value;
      if (!eppOriginal || !nuevaMarca) return;

      const epp = normalizarNombre(eppOriginal);
      if (!inventario[epp]) return alert('Ese EPP no existe en el inventario.');
      inventario[epp].codigo = nuevaMarca;
      mostrarInventario();
      guardarInventario();
    }

    function editarUbicacion() {
      const eppOriginal = document.getElementById('itemName').value;
      const nuevoTalle  = document.getElementById('itemLocation').value;
      if (!eppOriginal || !nuevoTalle) return;

      const epp = normalizarNombre(eppOriginal);
      if (!inventario[epp]) return alert('Ese EPP no existe en el inventario.');
      inventario[epp].ubicacion = nuevoTalle;
      mostrarInventario();
      guardarInventario();
    }

    /************************************
     * Exportar Excel
     ***********************************/
    function descargarExcel() {
      const data = Object.entries(inventario).map(([epp, datos]) => ({
        Cantidad: datos.cantidad,
        EPP: epp,
        Marca: datos.codigo,
        Talle: datos.ubicacion
      }));
      if (data.length === 0) return alert('El inventario está vacío.');

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
      XLSX.writeFile(wb, 'Inventario_EPP.xlsx');
    }

    /************************************
     * Persistencia local
     ***********************************/
    const guardarInventario = () => localStorage.setItem('inventario', JSON.stringify(inventario));

    function cargarInventario() {
      const data = localStorage.getItem('inventario');
      if (data) {
        inventario = JSON.parse(data);
        mostrarInventario();
      }
    }
    cargar
